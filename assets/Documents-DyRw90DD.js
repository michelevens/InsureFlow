import{j as e}from"./vendor-query-D5ml2kdZ.js";import{r}from"./vendor-react-C8VcOkCS.js";import{b as o,A as K,u as G,B as x,S as H,I as Q}from"./index-8sQqf4Gi.js";import{B as V}from"./Badge-CDix051U.js";import{M as E}from"./Modal-UQye4ZSv.js";import{ad as Z,F as S,az as L,at as v,Y as ee,d as te,a3 as se,aA as ae,aB as ne,aC as le}from"./vendor-ui-tJ0aMxU9.js";const h={async getDocuments(s,n){return o.get(`/documents?entity_type=${s}&entity_id=${n}`)},async uploadDocument(s){const n=new FormData;return n.append("file",s.file),n.append("entity_type",s.entity_type),n.append("entity_id",String(s.entity_id)),n.append("type",s.type),s.title&&n.append("title",s.title),o.upload("/documents",n)},getDownloadUrl(s){const n=localStorage.getItem("auth_token");return`${K}/documents/${s}/download?token=${n}`},async deleteDocument(s){return o.delete(`/documents/${s}`)}},w={async getMyPending(){return o.get("/signatures/pending")},async getForApplication(s){return o.get(`/applications/${s}/signatures`)},async requestSignature(s,n){return o.post(`/applications/${s}/signatures`,n)},async sign(s,n){return o.put(`/signatures/${s}/sign`,{signature_data:n})},async reject(s,n){return o.put(`/signatures/${s}/reject`,{reason:n})}},q={application_form:"Application Form",dec_page:"Declaration Page",binder:"Binder",coi:"Certificate of Insurance",endorsement:"Endorsement",id_document:"ID Document",proof_of_loss:"Proof of Loss",other:"Other"},re=Object.entries(q).map(([s,n])=>({value:s,label:n}));function ie(s){return s<1024?`${s} B`:s<1048576?`${(s/1024).toFixed(1)} KB`:`${(s/1048576).toFixed(1)} MB`}function ce(s){return s?s.startsWith("image/")?ne:s.includes("spreadsheet")||s.includes("csv")?le:S:ae}function pe({entityType:s="application",entityId:n}){const{user:D}=G(),[C,p]=r.useState([]),[u,f]=r.useState([]),[z,_]=r.useState(!0),[I,g]=r.useState(!1),[i,m]=r.useState(null),[O,U]=r.useState(!1),[j,k]=r.useState(null),[F,T]=r.useState("other"),[$,B]=r.useState(""),d=r.useRef(null),b=r.useRef(!1);r.useEffect(()=>{if(!n){_(!1);return}Promise.all([h.getDocuments(s,n),w.getMyPending()]).then(([t,a])=>{p(t.documents),f(a.signatures)}).catch(()=>{Z.error("Failed to load documents")}).finally(()=>_(!1))},[s,n]);const Y=async()=>{if(!(!j||!n)){U(!0);try{const t=await h.uploadDocument({file:j,entity_type:s,entity_id:n,type:F,title:$||void 0});p(a=>[t.document,...a]),g(!1),k(null),T("other"),B("")}catch{}finally{U(!1)}}},X=async t=>{if(confirm("Delete this document?"))try{await h.deleteDocument(t.id),p(a=>a.filter(l=>l.id!==t.id))}catch{}},N=r.useCallback(()=>{const t=d.current;if(!t)return;const a=t.getContext("2d");a&&(a.fillStyle="#ffffff",a.fillRect(0,0,t.width,t.height),a.strokeStyle="#1e293b",a.lineWidth=2,a.lineCap="round",a.lineJoin="round")},[]);r.useEffect(()=>{i&&setTimeout(N,100)},[i,N]);const M=t=>{const a=d.current;if(!a)return{x:0,y:0};const l=a.getBoundingClientRect(),c=a.width/l.width,A=a.height/l.height;return"touches"in t?{x:(t.touches[0].clientX-l.left)*c,y:(t.touches[0].clientY-l.top)*A}:{x:(t.clientX-l.left)*c,y:(t.clientY-l.top)*A}},R=t=>{b.current=!0;const{x:a,y:l}=M(t),c=d.current?.getContext("2d");c?.beginPath(),c?.moveTo(a,l)},P=t=>{if(!b.current)return;const{x:a,y:l}=M(t),c=d.current?.getContext("2d");c?.lineTo(a,l),c?.stroke()},y=()=>{b.current=!1},W=()=>{N()},J=async()=>{if(!i||!d.current)return;const t=d.current.toDataURL("image/png");try{await w.sign(i.id,t),f(a=>a.filter(l=>l.id!==i.id)),m(null)}catch{}};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-slate-900 flex items-center gap-3",children:[e.jsx(S,{className:"w-6 h-6 text-teal-600"}),"Documents"]}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"Manage insurance documents and e-signatures"})]}),n&&e.jsxs(x,{variant:"shield",onClick:()=>g(!0),children:[e.jsx(L,{className:"w-4 h-4 mr-2"})," Upload"]})]}),u.length>0&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"w-5 h-5 text-amber-600"}),e.jsxs("h3",{className:"font-semibold text-amber-900",children:[u.length," Signature",u.length>1?"s":""," Pending"]})]}),e.jsx("div",{className:"space-y-2",children:u.map(t=>e.jsxs("div",{className:"flex items-center justify-between bg-white rounded-lg p-3 border border-amber-100",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-slate-900",children:["From ",t.requester?.name||"Unknown"]}),e.jsxs("p",{className:"text-xs text-slate-500",children:[t.signer_role," signature"]})]}),e.jsxs(x,{variant:"shield",size:"sm",onClick:()=>m(t),children:[e.jsx(v,{className:"w-3.5 h-3.5 mr-1"})," Sign"]})]},t.id))})]}),e.jsx("div",{className:"bg-white rounded-xl border border-slate-200 overflow-hidden",children:z?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"w-6 h-6 border-2 border-teal-200 border-t-teal-600 rounded-full animate-spin"})}):C.length===0?e.jsxs("div",{className:"py-16 text-center",children:[e.jsx("div",{className:"w-14 h-14 bg-slate-100 rounded-xl flex items-center justify-center mx-auto mb-3",children:e.jsx(S,{className:"w-7 h-7 text-slate-400"})}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No documents yet"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Upload documents to get started"})]}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-slate-100",children:[e.jsx("th",{className:"text-left px-5 py-3 text-xs font-semibold text-slate-500 uppercase",children:"Document"}),e.jsx("th",{className:"text-left px-5 py-3 text-xs font-semibold text-slate-500 uppercase hidden sm:table-cell",children:"Type"}),e.jsx("th",{className:"text-left px-5 py-3 text-xs font-semibold text-slate-500 uppercase hidden md:table-cell",children:"Size"}),e.jsx("th",{className:"text-left px-5 py-3 text-xs font-semibold text-slate-500 uppercase hidden md:table-cell",children:"Uploaded By"}),e.jsx("th",{className:"text-right px-5 py-3 text-xs font-semibold text-slate-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{children:C.map(t=>{const a=ce(t.mime_type);return e.jsxs("tr",{className:"border-b border-slate-50 hover:bg-slate-50",children:[e.jsx("td",{className:"px-5 py-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 bg-teal-50 rounded-lg flex items-center justify-center",children:e.jsx(a,{className:"w-4.5 h-4.5 text-teal-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-900",children:t.title}),e.jsx("p",{className:"text-xs text-slate-400",children:t.file_name})]})]})}),e.jsx("td",{className:"px-5 py-3 hidden sm:table-cell",children:e.jsx(V,{variant:"default",size:"sm",children:q[t.type]||t.type})}),e.jsx("td",{className:"px-5 py-3 text-sm text-slate-500 hidden md:table-cell",children:ie(t.file_size)}),e.jsx("td",{className:"px-5 py-3 text-sm text-slate-500 hidden md:table-cell",children:t.uploader?.name||"â€”"}),e.jsx("td",{className:"px-5 py-3 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx("a",{href:h.getDownloadUrl(t.id),target:"_blank",rel:"noopener noreferrer",className:"p-1.5 rounded-lg hover:bg-teal-50 text-slate-400 hover:text-teal-600",children:e.jsx(ee,{className:"w-4 h-4"})}),(t.uploaded_by===D?.id||["admin","superadmin"].includes(D?.role||""))&&e.jsx("button",{onClick:()=>X(t),className:"p-1.5 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-600",children:e.jsx(te,{className:"w-4 h-4"})})]})})]},t.id)})})]})}),e.jsx(E,{isOpen:I,onClose:()=>g(!1),title:"Upload Document",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"File"}),e.jsx("input",{type:"file",onChange:t=>k(t.target.files?.[0]||null),className:"w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100",accept:".pdf,.doc,.docx,.png,.jpg,.jpeg,.xls,.xlsx,.csv"})]}),e.jsx(H,{label:"Document Type",value:F,onChange:t=>T(t.target.value),options:re}),e.jsx(Q,{label:"Title (optional)",placeholder:"Enter document title",value:$,onChange:t=>B(t.target.value)}),e.jsxs(x,{variant:"shield",className:"w-full",onClick:Y,disabled:!j,isLoading:O,children:[e.jsx(L,{className:"w-4 h-4 mr-2"})," Upload Document"]})]})}),e.jsx(E,{isOpen:!!i,onClose:()=>m(null),title:"Sign Document",children:i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:[e.jsx("strong",{children:"Requested by:"})," ",i.requester?.name||"Unknown"]}),e.jsxs("p",{className:"text-sm text-slate-600 mt-1",children:[e.jsx("strong",{children:"Role:"})," ",i.signer_role.replace("_"," ")]}),i.request_message&&e.jsxs("p",{className:"text-sm text-slate-500 mt-2 italic",children:['"',i.request_message,'"']})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Draw your signature below"}),e.jsx("div",{className:"border-2 border-dashed border-slate-300 rounded-xl overflow-hidden bg-white",children:e.jsx("canvas",{ref:d,width:500,height:200,className:"w-full cursor-crosshair touch-none",onMouseDown:R,onMouseMove:P,onMouseUp:y,onMouseLeave:y,onTouchStart:R,onTouchMove:P,onTouchEnd:y})}),e.jsx("button",{onClick:W,className:"text-xs text-slate-400 hover:text-slate-600 mt-1",children:"Clear signature"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(x,{variant:"shield",className:"flex-1",onClick:J,children:[e.jsx(v,{className:"w-4 h-4 mr-2"})," Sign"]}),e.jsxs(x,{variant:"outline",className:"flex-1",onClick:async()=>{await w.reject(i.id),f(t=>t.filter(a=>a.id!==i.id)),m(null)},children:[e.jsx(se,{className:"w-4 h-4 mr-2"})," Reject"]})]}),e.jsx("p",{className:"text-xs text-slate-400 text-center",children:"By signing, you agree to the terms of this document. Your IP address and browser information will be recorded."})]})})]})}export{pe as default};
