import{j as e}from"./vendor-query-D5ml2kdZ.js";import{r as n}from"./vendor-react-C8VcOkCS.js";import{ax as D,G as F,E as S,b1 as $,d as O,a3 as G,a2 as A,b8 as T,an as W,b9 as L,F as C,aC as M,Y as q,ad as h}from"./vendor-ui-tJ0aMxU9.js";import{b as f,B as o,C as N,I as k}from"./index-8sQqf4Gi.js";import{B as E}from"./Badge-CDix051U.js";import{M as _}from"./Modal-UQye4ZSv.js";const b={list:()=>f.get("/reports"),show:t=>f.get(`/reports/${t}`),create:t=>f.post("/reports",t),update:(t,l)=>f.put(`/reports/${t}`,l),destroy:t=>f.delete(`/reports/${t}`),run:(t,l="csv")=>f.post(`/reports/${t}/run`,{file_format:l}),runs:t=>f.get(`/reports/${t}/runs`),downloadRun:async t=>{const l=localStorage.getItem("auth_token"),r=await fetch(`http://localhost:8000/api/report-runs/${t}/download`,{headers:{Authorization:`Bearer ${l}`}});if(!r.ok)throw new Error("Download failed");const d=await r.blob(),u=r.headers.get("content-disposition")?.match(/filename="?([^"]+)"?/)?.[1]||"report",j=URL.createObjectURL(d),a=document.createElement("a");a.href=j,a.download=u,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(j)},emailRun:(t,l)=>f.post(`/report-runs/${t}/email`,l)},I={pending:{icon:W,color:"text-slate-400"},running:{icon:T,color:"text-blue-500"},completed:{icon:A,color:"text-green-500"},failed:{icon:G,color:"text-red-500"}},B={csv:M,pdf:C,json:L};function se(){const[t,l]=n.useState([]),[i,r]=n.useState(null),[d,m]=n.useState([]),[p,u]=n.useState(!0),[j,a]=n.useState(!1),[g,v]=n.useState(null),[w,c]=n.useState(null),y=async()=>{u(!0);try{const s=await b.list();l(s)}catch{h.error("Failed to load report definitions")}finally{u(!1)}};n.useEffect(()=>{y()},[]);const z=async s=>{r(s);try{const x=await b.runs(s.id);m(x)}catch{m([])}},U=async s=>{try{await b.destroy(s),h.success("Report definition deleted"),l(x=>x.filter(R=>R.id!==s)),i?.id===s&&(r(null),m([]))}catch{h.error("Failed to delete report definition")}},P=async s=>{try{await b.downloadRun(s.id),h.success("Report downloaded")}catch{h.error("Failed to download report")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:"Reports & BI Export"}),e.jsx("p",{className:"text-slate-500 mt-1",children:"Build custom reports with scheduled delivery"})]}),e.jsxs(o,{variant:"shield",onClick:()=>a(!0),children:[e.jsx(D,{className:"w-4 h-4 mr-1"})," New Report"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-3",children:p?e.jsx(N,{className:"p-8 text-center",children:e.jsx("div",{className:"w-8 h-8 border-4 border-shield-200 border-t-shield-600 rounded-full animate-spin mx-auto"})}):t.length===0?e.jsxs(N,{className:"p-12 text-center",children:[e.jsx(F,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500 mb-4",children:"No report definitions yet"}),e.jsxs(o,{variant:"shield",onClick:()=>a(!0),children:[e.jsx(D,{className:"w-4 h-4 mr-1"})," Create First Report"]})]}):t.map(s=>e.jsxs(N,{className:`p-4 cursor-pointer transition-all ${i?.id===s.id?"ring-2 ring-shield-500":"hover:shadow-md"}`,onClick:()=>z(s),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:s.description})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.schedule&&e.jsx(E,{variant:"info",children:s.schedule}),e.jsx(E,{variant:s.is_active?"success":"default",children:s.is_active?"Active":"Inactive"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-400",children:[s.recipients&&s.recipients.length>0&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"w-3 h-3"})," ",s.recipients.length," recipient(s)"]}),s.last_run_at&&e.jsxs("span",{children:["Last run: ",new Date(s.last_run_at).toLocaleDateString()]}),e.jsxs("span",{children:["Created: ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 pt-2 border-t border-slate-100",children:[e.jsxs(o,{variant:"shield",size:"sm",onClick:x=>{x.stopPropagation(),v(s)},children:[e.jsx($,{className:"w-3.5 h-3.5 mr-1"})," Run Now"]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:x=>{x.stopPropagation(),U(s.id)},children:e.jsx(O,{className:"w-3.5 h-3.5 text-red-400"})})]})]},s.id))}),e.jsx("div",{children:i?e.jsxs(N,{className:"p-5 sticky top-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-bold text-slate-900",children:"Report Runs"}),e.jsxs(o,{variant:"shield",size:"sm",onClick:()=>v(i),children:[e.jsx($,{className:"w-3.5 h-3.5 mr-1"})," Run"]})]}),e.jsxs("div",{className:"space-y-3",children:[d.map(s=>{const x=I[s.status]||I.pending,R=B[s.file_format]||C;return e.jsxs("div",{className:"bg-slate-50 rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x.icon,{className:`w-4 h-4 ${x.color} ${s.status==="running"?"animate-spin":""}`}),e.jsx("span",{className:"text-sm font-medium text-slate-900 capitalize",children:s.status})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-slate-400",children:[e.jsx(R,{className:"w-3 h-3"}),e.jsx("span",{children:s.file_format.toUpperCase()})]})]}),e.jsx("div",{className:"text-xs text-slate-500",children:s.completed_at?e.jsxs("span",{children:[s.row_count.toLocaleString()," rows • ",new Date(s.completed_at).toLocaleString()]}):s.started_at?e.jsxs("span",{children:["Started ",new Date(s.started_at).toLocaleString()]}):e.jsxs("span",{children:["Queued ",new Date(s.created_at).toLocaleString()]})}),s.error_message&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:s.error_message}),s.status==="completed"&&s.file_path&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>P(s),children:[e.jsx(q,{className:"w-3.5 h-3.5 mr-1"})," Download"]}),e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>c(s),children:[e.jsx(S,{className:"w-3.5 h-3.5 mr-1"})," Email"]})]})]},s.id)}),d.length===0&&e.jsx("p",{className:"text-sm text-slate-400 text-center py-4",children:"No runs yet"})]})]}):e.jsxs(N,{className:"p-8 text-center text-slate-400",children:[e.jsx(F,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Select a report to view runs"})]})})]}),j&&e.jsx(Q,{onClose:()=>a(!1),onCreated:()=>{y(),a(!1)}}),g&&e.jsx(H,{definition:g,onClose:()=>v(null),onRun:s=>{m(x=>[s,...x]),(!i||i.id===g.id)&&r(g),v(null)}}),w&&e.jsx(J,{run:w,onClose:()=>c(null)})]})}function H({definition:t,onClose:l,onRun:i}){const[r,d]=n.useState("csv"),[m,p]=n.useState(!1),u=async()=>{p(!0);try{const a=await b.run(t.id,r);h.success(`Report generated as ${r.toUpperCase()}`),i(a)}catch{h.error("Failed to run report")}finally{p(!1)}},j=[{value:"csv",label:"CSV",desc:"Spreadsheet format, compatible with Excel",Icon:M},{value:"pdf",label:"PDF",desc:"Printable document with formatted table",Icon:C},{value:"json",label:"JSON",desc:"Machine-readable data for integrations",Icon:L}];return e.jsx(_,{isOpen:!0,onClose:l,title:`Run: ${t.name}`,size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-2",children:"Export Format"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:j.map(a=>e.jsxs("button",{onClick:()=>d(a.value),className:`p-3 rounded-xl border-2 text-center transition-all ${r===a.value?"border-shield-500 bg-shield-50 text-shield-700":"border-slate-200 hover:border-slate-300 text-slate-600"}`,children:[e.jsx(a.Icon,{className:"w-6 h-6 mx-auto mb-1"}),e.jsx("p",{className:"text-sm font-medium",children:a.label}),e.jsx("p",{className:"text-xs text-slate-400 mt-0.5",children:a.desc})]},a.value))})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(o,{variant:"ghost",onClick:l,children:"Cancel"}),e.jsx(o,{variant:"shield",onClick:u,disabled:m,children:m?"Generating...":`Generate ${r.toUpperCase()}`})]})]})})}function J({run:t,onClose:l}){const[i,r]=n.useState(""),[d,m]=n.useState(""),[p,u]=n.useState(!1),j=async()=>{const a=i.split(",").map(g=>g.trim()).filter(Boolean);if(a.length===0){h.error("Enter at least one email address");return}u(!0);try{const g=await b.emailRun(t.id,{recipients:a,message:d||void 0});h.success(g.message),l()}catch{h.error("Failed to send report email")}finally{u(!1)}};return e.jsx(_,{isOpen:!0,onClose:l,title:"Email Report",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 rounded-xl p-3 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-shield-50 flex items-center justify-center",children:(()=>{const a=B[t.file_format]||C;return e.jsx(a,{className:"w-5 h-5 text-shield-600"})})()}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-slate-900",children:[t.file_format.toUpperCase()," Report"]}),e.jsxs("p",{className:"text-xs text-slate-500",children:[t.row_count.toLocaleString()," rows • ",t.completed_at?new Date(t.completed_at).toLocaleString():""]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Recipients"}),e.jsx(k,{placeholder:"email@example.com, another@example.com",value:i,onChange:a=>r(a.target.value)}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Separate multiple emails with commas"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Message (optional)"}),e.jsx("textarea",{value:d,onChange:a=>m(a.target.value),className:"w-full h-20 text-sm border border-slate-200 rounded-lg p-3 focus:ring-2 focus:ring-shield-500 focus:border-shield-500",placeholder:"Here's the latest report..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(o,{variant:"ghost",onClick:l,children:"Cancel"}),e.jsxs(o,{variant:"shield",onClick:j,disabled:p||!i.trim(),children:[e.jsx(S,{className:"w-4 h-4 mr-1"}),p?"Sending...":"Send Report"]})]})]})})}function Q({onClose:t,onCreated:l}){const[i,r]=n.useState(""),[d,m]=n.useState(""),[p,u]=n.useState(""),[j,a]=n.useState(""),[g,v]=n.useState(!1),w=async()=>{if(!i)return;const c=j.split(",").map(y=>y.trim()).filter(Boolean);v(!0);try{await b.create({name:i,description:d||null,query_config:{},schedule:p||null,recipients:c.length>0?c:null}),h.success("Report definition created successfully"),l()}catch{h.error("Failed to create report definition")}finally{v(!1)}};return e.jsx(_,{isOpen:!0,onClose:t,title:"New Report Definition",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(k,{label:"Report Name",placeholder:"Monthly Production Summary",value:i,onChange:c=>r(c.target.value)}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Description"}),e.jsx("textarea",{value:d,onChange:c=>m(c.target.value),className:"w-full h-20 text-sm border border-slate-200 rounded-lg p-3 focus:ring-2 focus:ring-shield-500 focus:border-shield-500",placeholder:"What this report covers..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Schedule (optional)"}),e.jsxs("select",{value:p,onChange:c=>u(c.target.value),className:"w-full text-sm border border-slate-200 rounded-lg px-3 py-2",children:[e.jsx("option",{value:"",children:"No schedule (run manually)"}),e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"monthly",children:"Monthly"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700 block mb-1",children:"Email Recipients (optional)"}),e.jsx(k,{placeholder:"email@example.com, another@example.com",value:j,onChange:c=>a(c.target.value)}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Reports will be emailed to these addresses on schedule"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(o,{variant:"ghost",onClick:t,children:"Cancel"}),e.jsx(o,{variant:"shield",onClick:w,disabled:g||!i,children:g?"Creating...":"Create Report"})]})]})})}export{se as default};
