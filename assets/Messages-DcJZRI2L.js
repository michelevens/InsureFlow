import{j as e}from"./vendor-query-D5ml2kdZ.js";import{r as a}from"./vendor-react-C8VcOkCS.js";import{b as j,u as ee,B as U,I as se}from"./index-BZEM9EbM.js";import{B as te}from"./Badge-8fS5vckW.js";import{M as ae}from"./Modal-Cn8_xSIn.js";import{M as B,ax as ne,A as re,C as le,ac as ce,ay as Y,e as K,ae as ie,u as oe}from"./vendor-ui-tJ0aMxU9.js";const w={async getConversations(){return j.get("/conversations")},async startConversation(t){return j.post("/conversations",t)},async searchUsers(t){const l=t?`?q=${encodeURIComponent(t)}`:"";return j.get(`/conversations/users${l}`)},async getMessages(t){return j.get(`/conversations/${t}/messages`)},async getNewMessages(t,l){return j.get(`/conversations/${t}/new-messages?after=${l}`)},async sendMessage(t,l){return j.post(`/conversations/${t}/messages`,{body:l})},async sendTyping(t){return j.post(`/conversations/${t}/typing`)},async getTypingStatus(t){return j.get(`/conversations/${t}/typing`)},async markRead(t){return j.put(`/messages/${t}/read`)}},de=3e3,ue=15e3,me=1e4,xe=3e4,fe=2e3,he=2e3,ge=4e3;function pe(t){const[l,h]=a.useState([]),[d,c]=a.useState([]),[g,u]=a.useState(!1),[k,$]=a.useState(!0),[V,L]=a.useState(!1),o=a.useRef(!0),m=a.useRef(0),p=a.useRef(null),x=a.useRef(null),N=a.useRef(null),y=a.useRef(null),S=a.useRef(null);a.useEffect(()=>{const n=()=>{o.current=!0},r=()=>{o.current=!1},f=()=>{o.current=document.visibilityState==="visible"};return window.addEventListener("focus",n),window.addEventListener("blur",r),document.addEventListener("visibilitychange",f),()=>{window.removeEventListener("focus",n),window.removeEventListener("blur",r),document.removeEventListener("visibilitychange",f)}},[]);const i=a.useCallback(async()=>{try{const n=await w.getConversations();h(n.conversations)}catch{}finally{$(!1)}},[]),v=a.useCallback(async n=>{L(!0);try{const r=await w.getMessages(n);c(r.messages),r.messages.length>0?m.current=r.messages[r.messages.length-1].id:m.current=0}catch{}finally{L(!1)}},[]),T=a.useCallback(async()=>{if(!(!t||!o.current))try{const n=await w.getNewMessages(t,m.current);n.messages.length>0&&(c(r=>[...r,...n.messages]),m.current=n.messages[n.messages.length-1].id,i())}catch{}},[t,i]);a.useEffect(()=>{i()},[i]),a.useEffect(()=>{t?(v(t),u(!1)):(c([]),m.current=0)},[t,v]),a.useEffect(()=>{if(!t)return;const n=()=>{N.current&&clearInterval(N.current);const f=o.current?de:ue;N.current=setInterval(T,f)};n();const r=()=>n();return window.addEventListener("focus",r),()=>{N.current&&clearInterval(N.current),window.removeEventListener("focus",r)}},[t,T]),a.useEffect(()=>{const n=()=>{y.current&&clearInterval(y.current);const f=o.current?me:xe;y.current=setInterval(i,f)};n();const r=()=>n();return window.addEventListener("focus",r),()=>{y.current&&clearInterval(y.current),window.removeEventListener("focus",r)}},[i]),a.useEffect(()=>{if(t)return S.current=setInterval(async()=>{if(o.current)try{(await w.getTypingStatus(t)).is_typing&&(u(!0),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>u(!1),ge))}catch{}},he),()=>{S.current&&clearInterval(S.current),x.current&&clearTimeout(x.current)}},[t]);const I=a.useCallback(()=>{t&&(p.current||(w.sendTyping(t).catch(()=>{}),p.current=setTimeout(()=>{p.current=null},fe)))},[t]),P=a.useCallback(async n=>{if(!t)return;const r=Date.now(),f={id:r,sender_id:-1,body:n,type:"text",attachment_url:null,read_at:null,created_at:new Date().toISOString()};c(b=>[...b,f]);try{const b=await w.sendMessage(t,n);c(_=>_.map(D=>D.id===r?b.message:D)),m.current=b.message.id,i()}catch{c(b=>b.filter(_=>_.id!==r))}},[t,i]),M=l.reduce((n,r)=>n+r.unread_count,0);return{conversations:l,messages:d,isOtherTyping:g,loadingConvs:k,loadingMsgs:V,totalUnread:M,sendMessage:P,sendTyping:I,fetchConversations:i,setMessages:c}}function je(t){const l=new Date(t),d=new Date().getTime()-l.getTime(),c=Math.floor(d/6e4);if(c<1)return"Just now";if(c<60)return`${c}m ago`;const g=Math.floor(c/60);if(g<24)return`${g}h ago`;const u=Math.floor(g/24);return u<7?`${u}d ago`:l.toLocaleDateString()}function ye(t){const l=new Date(t),h=new Date,d=new Date(h);return d.setDate(d.getDate()-1),l.toDateString()===h.toDateString()?"Today":l.toDateString()===d.toDateString()?"Yesterday":l.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})}const z={consumer:"bg-blue-100 text-blue-700",agent:"bg-teal-100 text-teal-700",agency_owner:"bg-purple-100 text-purple-700",carrier:"bg-amber-100 text-amber-700",admin:"bg-red-100 text-red-700",superadmin:"bg-red-100 text-red-700"};function Ce(){const{user:t}=ee(),[l,h]=a.useState(null),[d,c]=a.useState(!1),[g,u]=a.useState(""),[k,$]=a.useState([]),[V,L]=a.useState(!1),[o,m]=a.useState(""),[p,x]=a.useState(null),[N,y]=a.useState(!1),[S,i]=a.useState(!1),[v,T]=a.useState(""),I=a.useRef(null),P=a.useRef(null),{conversations:M,messages:n,isOtherTyping:r,loadingConvs:f,loadingMsgs:b,totalUnread:_,sendMessage:D,sendTyping:q,fetchConversations:H}=pe(l),R=M.find(s=>s.id===l)||null;a.useEffect(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[n,r]),a.useEffect(()=>{l&&P.current?.focus()},[l]);const F=a.useCallback(async()=>{const s=v.trim();s&&(T(""),await D(s))},[v,D]),J=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),F())},W=s=>{T(s.target.value),q()},X=s=>{h(s.id),i(!0)},Q=()=>{i(!1),h(null)};a.useEffect(()=>{if(!d)return;const s=setTimeout(async()=>{L(!0);try{const C=await w.searchUsers(g||void 0);$(C.users)}catch{$([])}finally{L(!1)}},300);return()=>clearTimeout(s)},[g,d]);const Z=async()=>{if(!(!p||!o.trim())){y(!0);try{const s=await w.startConversation({recipient_id:p.id,body:o.trim()});c(!1),x(null),m(""),u(""),H(),h(s.conversation.id),i(!0)}catch{}finally{y(!1)}}},O=[];let G="";for(const s of n){const C=new Date(s.created_at).toDateString();C!==G&&(G=C,O.push({date:s.created_at,msgs:[]})),O[O.length-1].msgs.push(s)}return e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex",children:[e.jsxs("div",{className:`w-full md:w-80 lg:w-96 border-r border-slate-200 flex flex-col bg-white ${S?"hidden md:flex":"flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-slate-200",children:e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h1",{className:"text-lg font-bold text-slate-900 flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-teal-600"}),"Messages",_>0&&e.jsx(te,{variant:"danger",size:"sm",children:_})]}),e.jsx(U,{variant:"shield",size:"sm",onClick:()=>c(!0),children:e.jsx(ne,{className:"w-4 h-4"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:f?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"w-6 h-6 border-2 border-teal-200 border-t-teal-600 rounded-full animate-spin"})}):M.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-teal-50 rounded-xl flex items-center justify-center mb-3",children:e.jsx(B,{className:"w-6 h-6 text-teal-500"})}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No conversations yet"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Start a conversation to get going"}),e.jsx(U,{variant:"shield",size:"sm",className:"mt-4",onClick:()=>c(!0),children:"New Message"})]}):M.map(s=>e.jsxs("button",{onClick:()=>X(s),className:`w-full flex items-start gap-3 p-4 border-b border-slate-100 text-left hover:bg-slate-50 transition-colors ${l===s.id?"bg-teal-50 border-l-2 border-l-teal-500":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center text-white font-semibold text-sm shrink-0",children:s.other_user.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-slate-900 truncate",children:s.other_user.name}),s.last_message_at&&e.jsx("span",{className:"text-xs text-slate-400 shrink-0 ml-2",children:je(s.last_message_at)})]}),e.jsx("div",{className:"flex items-center gap-1.5 mt-0.5",children:e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${z[s.other_user.role]||"bg-slate-100 text-slate-600"}`,children:s.other_user.role.replace("_"," ")})}),s.last_message&&e.jsx("p",{className:"text-sm text-slate-500 truncate mt-1",children:s.last_message})]}),s.unread_count>0&&e.jsx("div",{className:"w-5 h-5 bg-teal-500 rounded-full flex items-center justify-center shrink-0 mt-1",children:e.jsx("span",{className:"text-xs text-white font-medium",children:s.unread_count})})]},s.id))})]}),e.jsx("div",{className:`flex-1 flex flex-col bg-slate-50 ${S?"flex":"hidden md:flex"}`,children:R?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-white border-b border-slate-200 flex items-center gap-3",children:[e.jsx("button",{onClick:Q,className:"md:hidden p-1 hover:bg-slate-100 rounded-lg",children:e.jsx(re,{className:"w-5 h-5 text-slate-600"})}),e.jsx("div",{className:"w-9 h-9 rounded-full bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center text-white font-semibold text-sm",children:R.other_user.name.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-900",children:R.other_user.name}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${z[R.other_user.role]||"bg-slate-100 text-slate-600"}`,children:R.other_user.role.replace("_"," ")}),r&&e.jsx("span",{className:"text-xs text-teal-600 animate-pulse",children:"typing..."})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-1",children:[b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"w-6 h-6 border-2 border-teal-200 border-t-teal-600 rounded-full animate-spin"})}):n.length===0?e.jsx("div",{className:"flex items-center justify-center py-12 text-slate-400 text-sm",children:"No messages yet. Say hello!"}):O.map((s,C)=>e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:"bg-slate-200 text-slate-500 text-xs px-3 py-1 rounded-full",children:ye(s.date)})}),s.msgs.map(E=>{const A=E.sender_id===t?.id||E.sender_id===-1;return e.jsx("div",{className:`flex mb-2 ${A?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-2xl px-4 py-2.5 ${A?"bg-teal-600 text-white rounded-br-md":"bg-white text-slate-900 border border-slate-200 rounded-bl-md"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:E.body}),e.jsxs("div",{className:`flex items-center justify-end gap-1 mt-1 ${A?"text-teal-200":"text-slate-400"}`,children:[e.jsx("span",{className:"text-[10px]",children:new Date(E.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),A&&(E.read_at?e.jsx(le,{className:"w-3.5 h-3.5"}):e.jsx(ce,{className:"w-3.5 h-3.5"}))]})]})},E.id)})]},C)),r&&e.jsx("div",{className:"flex justify-start mb-2",children:e.jsx("div",{className:"bg-white border border-slate-200 rounded-2xl rounded-bl-md px-4 py-3",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(Y,{className:"w-2 h-2 text-slate-400 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx(Y,{className:"w-2 h-2 text-slate-400 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx(Y,{className:"w-2 h-2 text-slate-400 animate-bounce",style:{animationDelay:"300ms"}})]})})}),e.jsx("div",{ref:I})]}),e.jsx("div",{className:"p-4 bg-white border-t border-slate-200",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{ref:P,type:"text",value:v,onChange:W,onKeyDown:J,placeholder:"Type a message...",className:"flex-1 px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent"}),e.jsx(U,{variant:"shield",onClick:F,disabled:!v.trim(),children:e.jsx(K,{className:"w-4 h-4"})})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-center px-4",children:[e.jsx("div",{className:"w-16 h-16 bg-teal-50 rounded-2xl flex items-center justify-center mb-4",children:e.jsx(B,{className:"w-8 h-8 text-teal-500"})}),e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Select a Conversation"}),e.jsx("p",{className:"text-sm text-slate-500 mt-1 max-w-xs",children:"Choose an existing conversation or start a new one to begin messaging."})]})}),e.jsx(ae,{isOpen:d,onClose:()=>{c(!1),x(null),m(""),u("")},title:"New Message",children:e.jsx("div",{className:"space-y-4",children:p?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-teal-50 rounded-xl border border-teal-100",children:[e.jsx(oe,{className:"w-5 h-5 text-teal-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-teal-900",children:["To: ",p.name]}),e.jsx("p",{className:"text-xs text-teal-600",children:p.role.replace("_"," ")})]}),e.jsx("button",{onClick:()=>x(null),className:"ml-auto text-teal-500 hover:text-teal-700",children:"Ã—"})]}),e.jsx("textarea",{value:o,onChange:s=>m(s.target.value),placeholder:"Write your message...",rows:4,className:"w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent resize-none"}),e.jsxs(U,{variant:"shield",className:"w-full",onClick:Z,disabled:!o.trim(),isLoading:N,children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Send Message"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{label:"Search users",placeholder:"Name or email...",value:g,onChange:s=>u(s.target.value),leftIcon:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-1",children:V?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx("div",{className:"w-5 h-5 border-2 border-teal-200 border-t-teal-600 rounded-full animate-spin"})}):k.length===0?e.jsx("p",{className:"text-sm text-slate-400 text-center py-4",children:"No users found"}):k.map(s=>e.jsxs("button",{onClick:()=>x(s),className:"w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors text-left",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center text-white font-semibold text-sm",children:s.name.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-900",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-slate-400",children:s.email}),e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded-full ${z[s.role]||"bg-slate-100 text-slate-600"}`,children:s.role.replace("_"," ")})]})]})]},s.id))})]})})})]})}export{Ce as default};
